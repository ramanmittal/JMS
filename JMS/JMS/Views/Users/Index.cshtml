@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf;
@using JMS.Service.Enums;
@using Newtonsoft.Json;
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}
@{
    ViewData["Title"] = "Users";
}

<link href="~/plugins/jsgrid/jsgrid.min.css" rel="stylesheet" />
<link href="~/plugins/jsgrid/jsgrid-theme.css" rel="stylesheet" />
@section contentheader{
    <h1>Users</h1>
}
<div class="text-right">
    <a class="btn btn-primary mb-2" asp-action="Create" asp-controller="Journals">Create User</a>
</div>

<div id="jsGrid"></div>
@section scripts{
    <script src="~/plugins/jsgrid/jsgrid.js"></script>
    <script src="~/plugins/jsgrid/multiselectjsgrid.js"></script>
    <script>
        $(function () {
            $("#jsGrid").jsGrid({
               height: "auto",
                width: "100%",
                onDataLoaded: function (args) {
                    $('[data-toggle="tooltip"]').tooltip()
                },
                paging: true,
                pageSize: 10,
               pageLoading: true,
                autoload: true,
                filtering: true,
                sorting :true,
               controller: {
                   loadData: function (filter) {
                var d = $.Deferred();
                $.ajax({
                    url: "@Url.Action("JournalUsers", "Users")",
                    dataType: "json",
                    data: filter
                }).done(function(response) {
                    d.resolve(response);
                });
                return d.promise();
                }
               },
                fields: [
                    {
                        name: "", itemTemplate: function (value, item) {
                            return "<a target='_blank' href='/" + item.profileImage + "'><img class='grid-image' src='" + item.profileImage + "'/></a>"
                        }, width:"80px"
                    },
                    {
                        name: "Name", type: "text", itemTemplate: function (value, item) {
                            return "<span>" + item.firstName + " " + item.lastName+"</span>"
                        }
                    },
                    {
                        name: "Email", type: "text", itemTemplate: function (value, item) {
                            return "<span>" + item.userName+"</span>"
                        }
                    },
                    {
                        name: "Roles", autosearch: true, type: "multiselect",items:@(Html.Raw(JsonConvert.SerializeObject(RoleHelper.GetRolesForUser()))), sorting: false, id: Math.random().toString(36).substring(7), itemTemplate: function (value, item) {
                            return "<span>" + (item.roles) + "</span>"
                        }
                    },
                    {
                        name: "Status", sorting: false, type: "checkbox", itemTemplate: function (value, item) {
                            return "<span>" + (item.isDisabled ? "InActive" : "Active") + "</span>"
                        }
                    },
                    {
                        name: "", type: "control", itemTemplate: function (value, item) {
                            return `<a class="fa fa-edit" title="Edit" data-toggle="tooltip" data-placement="top"  href="@Url.Action("Edit","Journals")?id=${item.id}"></a>
                                    <a class="fas fa-trash-alt" title="Delete" data-toggle="tooltip" data-placement="top" href="javascript:dltjrndlg(${item.id});"></a>`
                        }
                    }
               ]
            });

        });
        function dltjrndlg(journalId) {
            $("#myModal .modal-body").html(`
                <h3 class="text-center">Are you sure you want to permanently remove this journal?</h3>
                <div  class="text-center">
                     <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">Cancel</button>
                     <button type="button" class="btn btn-primary btn-lg" onclick="dltjrn(${journalId})">Yes</button>
                </div>
                `);
            $("#myModal").modal({
                backdrop: 'static',
                keyboard: false
            })
        }
        function dltjrn(journalId) {
            $(".loader").show();
            $.ajax({
                type: "POST",
                data: {
                    __RequestVerificationToken: "@(GetAntiXsrfRequestToken())",
                    id: journalId
                },
                url: "@Url.Action("Delete")",
                success: function () {
                    window.location.reload();
                }
            });
        }
    </script>
}

